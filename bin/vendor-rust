#!/bin/bash

# Packaging script for Rust:
# create vendor tarball
# for the related source.

# remove previous artifact, if any
destdir="/dev/shm"
target="vendor.tar.xz"
if [[ -f "$target" ]]; then
	rm $target
fi

# determine project name
# and source tar location
project=$(basename "$PWD")
file=`ls *${project}*tar*`
foldername=$(tar --exclude="*/*" -tf $file)

cp $file $destdir

# traverse into source dir
pushd $destdir

tar xf $file
pushd $foldername

cargo vendor

time tar -cf - vendor/ |  xz -9 -c - > "$target"

# get back to project dir
popd
popd

tarball="$destdir/$foldername/$target"

ls -lh $tarball

echo -n "Copying ..."
cp $tarball .
echo -n "done"

